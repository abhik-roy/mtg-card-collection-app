datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Finish {
  NONFOIL
  FOIL
  ETCHED
}

enum Condition {
  NM
  LP
  MP
  HP
  DMG
}

enum PriceDirection {
  UP
  DOWN
}

enum PriceType {
  USD
  USD_FOIL
}

enum MarketplaceListingType {
  BUY
  SELL
}

model CollectionEntry {
  id            String    @id @default(cuid())
  userId        String?
  cardId        String
  quantity      Int       @default(1)
  finish        Finish    @default(NONFOIL)
  condition     Condition @default(NM)
  language      String    @default("en")
  acquiredPrice Float?
  acquiredDate  DateTime?
  location      String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  catalogCache  CatalogCache? @relation(fields: [cardId], references: [cardId])
  user          User?         @relation(fields: [userId], references: [id])

  @@index([userId])
}

model CatalogCache {
  cardId          String   @id
  name            String
  setCode         String
  collectorNumber String
  lang            String
  rarity          String?
  colorIdentity   String?
  typeLine        String?
  setType         String?
  releasedAt      DateTime?
  manaValue       Float?
  formats         Json?
  imageSmall      String?
  imageNormal     String?
  usd             Float?
  usdFoil         Float?
  cachedAt        DateTime @default(now())

  collectionEntries CollectionEntry[]

  @@index([name])
  @@index([setCode])
}

model PriceSnapshot {
  cardId         String
  asOfDate       DateTime
  usd            Float?
  usdFoil        Float?
  listingsCount  Int?
  buylistPrice   Float?
  demandScore    Float?
  createdAt      DateTime @default(now())

  @@id([cardId, asOfDate])
  @@index([asOfDate])
}

model PortfolioValueSnapshot {
  userId         String
  asOfDate       DateTime
  totalValue     Float
  costBasis      Float
  cashIn         Float?
  cashOut        Float?
  benchmarkValue Float?
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, asOfDate])
  @@index([asOfDate])
}

model CardLiquiditySnapshot {
  cardId        String
  asOfDate      DateTime
  listingsCount Int
  buylistCount  Int?
  buylistHigh   Float?
  createdAt     DateTime @default(now())

  @@id([cardId, asOfDate])
  @@index([asOfDate])
}

model PriceWatch {
  id               String          @id @default(cuid())
  cardId           String
  direction        PriceDirection  @default(UP)
  priceType        PriceType       @default(USD)
  thresholdPercent Float
  contact          String
  lastPrice        Float?
  lastNotifiedAt   DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([cardId])
  @@index([contact])
}

enum IdentityProvider {
  GOOGLE
  DISCORD
}

model User {
  id                String            @id @default(cuid())
  email             String            @unique
  passwordHash      String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  collectionEntries CollectionEntry[]
  decks             Deck[]
  externalIdentities ExternalIdentity[]
  marketplaceListings MarketplaceListing[]
  portfolioSnapshots PortfolioValueSnapshot[]
}

model Deck {
  id          String     @id @default(cuid())
  userId      String
  name        String
  format      String?
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user  User      @relation(fields: [userId], references: [id])
  cards DeckCard[]

  @@index([userId])
}

enum DeckBoard {
  MAIN
  SIDE
}

model DeckCard {
  id        String    @id @default(cuid())
  deckId    String
  cardId    String
  quantity  Int
  board     DeckBoard @default(MAIN)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  deck Deck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([deckId, cardId, board])
  @@index([deckId])
}

model ExternalIdentity {
  id             String            @id @default(cuid())
  userId         String
  provider       IdentityProvider
  providerUserId String
  email          String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([email])
  @@index([userId])
}

model MarketplaceListing {
  id        String                  @id @default(cuid())
  userId    String
  type      MarketplaceListingType
  cardId    String?
  cardName  String
  setCode   String?
  condition String?
  quantity  Int                     @default(1)
  price     Float?
  currency  String                  @default("USD")
  notes     String?
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([cardName])
  @@index([setCode])
}
